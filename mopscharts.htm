<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯›åˆ©ç‡èˆ‡æ·¨åˆ©ç‡åˆ†æåœ–è¡¨</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, "Microsoft JhengHei", sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }
        
        #filter-panel {
            background-color: white;
            padding: 5px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .filter-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .filter-group label {
            font-weight: bold;
            color: #555;
        }
        
        .filter-group input[type="number"] {
            width: 80px;
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            text-align: right;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 10px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0056b3;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #545b62;
        }

        .btn[disabled] {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        #filter-stats {
            margin-top: 10px;
            padding: 10px;
            background-color: #e7f3ff;
            border-left: 4px solid #007bff;
            border-radius: 4px;
            font-size: 14px;
            color: #004085;
        }
        
        #charts-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }
        
        .chart-wrapper {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-width: 0;
            /* cursor: move; */
            cursor: pointer;
            transition: box-shadow 0.3s, transform 0.1s;
            position: relative;
        }
        
        .chart-wrapper:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .chart-wrapper.dragging {
            opacity: 0.7;
            z-index: 1000;
            transform: scale(1.05);
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }
        
        .chart-canvas {
            width: 100% !important;
            height: 250px !important;
        }
        
        #loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #666;
        }
        
        .search-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .search-group input[type="text"] {
            width: 200px;
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            text-align: right;
        }
        
        .chart-wrapper.highlight {
            animation: highlight-pulse 1.5s ease-in-out;
            border: 3px solid #007bff;
            box-shadow: 0 0 20px rgba(0, 123, 255, 0.5);
        }
        
        @keyframes highlight-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        .input-with-tooltip {
            position: relative;
            display: inline-block;
        }
        
        .input-tooltip {
            visibility: hidden;
            background-color: #333;
            color: #fff;
            text-align: center;
            padding: 6px 10px;
            border-radius: 6px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .input-tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        
        .input-with-tooltip:hover .input-tooltip {
            visibility: visible;
            opacity: 1;
        }
        
        @media (max-width: 1400px) {
            #charts-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 1000px) {
            #charts-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 600px) {
            #charts-container {
                grid-template-columns: repeat(1, 1fr);
            }
        }
        
        #backToTop {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(144, 238, 144, 0.7);
            color: #333;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            font-family: Arial, "Microsoft JhengHei", sans-serif;
        }
        
        #backToTop:hover {
            background-color: rgba(144, 238, 144, 0.9);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
        }
        
        #backToTop.show {
            display: block;
        }
        
        /* é—œä¿‚åœ–æ¨£å¼ */
        #relationship-diagram {
            background: linear-gradient(135deg, #1e7e8c 0%, #0d4f5c 100%);
            padding: 30px;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        #relationship-diagram h2 {
            color: white;
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .waterfall-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 20px;
            height: 450px;
            position: relative;
        }
        
        .waterfall-bar {
            width: 140px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        
        .bar-stack {
            width: 100%;
            border: 3px solid #2c3e50;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
        }
        
        .bar-section {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            text-align: center;
            padding: 10px;
            font-size: 16px;
            line-height: 1.4;
            position: relative;
        }
        
        .bar-section.cost {
            background: linear-gradient(135deg, #5dade2 0%, #3498db 100%);
            border-bottom: 2px dashed #2c3e50;
        }
        
        .bar-section.remaining {
            background: linear-gradient(135deg, #ec7063 0%, #e74c3c 100%);
        }
        
        .bar-section.profit {
            background: linear-gradient(135deg, #ec7063 0%, #e74c3c 100%);
        }
        
        .bar-section.income {
            background: linear-gradient(135deg, #5dade2 0%, #3498db 100%);
        }
        
        .bar-label {
            margin-top: 10px;
            font-size: 14px;
            font-weight: bold;
            color: #2c3e50;
            text-align: center;
        }
        
        .arrow-connector {
            font-size: 48px;
            color: #34495e;
            align-self: center;
            margin-bottom: 80px;
            font-weight: bold;
            transform: translateY(60px);
        }
        
        .bar-stack.height-100 {
            height: 350px;
        }
        
        .bar-stack.height-80 {
            height: 280px;
        }
        
        .bar-stack.height-60 {
            height: 210px;
        }
        
        .bar-stack.height-50 {
            height: 175px;
        }
        
        .bar-stack.height-40 {
            height: 140px;
        }
        
        .info-note {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #e74c3c;
            color: #2c3e50;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
        }
        
        .formula-box {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #1e7e8c;
        }
        
        .formula-box h3 {
            color: #1e7e8c;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .formula-item {
            color: #2c3e50;
            margin: 8px 0;
            font-size: 15px;
            line-height: 1.6;
        }
        
        .formula-item strong {
            color: #e74c3c;
        }
        
        .bar-label .deduct-text {
            color: #e74c3c;
            font-weight: bold;
        }
        
        #diagram-toggle-btn {
            background: rgba(255, 255, 255, 0.9);
            color: #1e7e8c;
            border: 2px solid rgba(255, 255, 255, 0.5);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0 auto;
            display: block;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        #diagram-toggle-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        #diagram-content {
            display: none;
            margin-top: 20px;
        }
        
        #diagram-content.show {
            display: block;
        }
    </style>
</head>
<body>
    <h1>2025-Q4 æ¯›åˆ©ç‡ã€æ·¨åˆ©ç‡ã€ç‡Ÿæ¥­æ”¶å…¥åˆ†æåœ–è¡¨</h1>
    
    <!-- é—œä¿‚åœ– -->
    <div id="relationship-diagram">
        <button id="diagram-toggle-btn" onclick="toggleDiagram()">â–¼ å±•é–‹ æ¯›åˆ©ç‡èˆ‡æ·¨åˆ©ç‡è¨ˆç®—ç€‘å¸ƒåœ–</button>
        
        <div id="diagram-content">
        
        <div class="waterfall-container">
            <!-- ç‡Ÿæ¥­æ”¶å…¥ -->
            <div class="waterfall-bar">
                <div class="bar-stack height-100">
                    <div class="bar-section income" style="flex: 1;">
                        ç‡Ÿæ¥­<br>æ”¶å…¥
                    </div>
                </div>
                <div class="bar-label">ç‡Ÿæ¥­æ”¶å…¥</div>
            </div>
            
            <div class="arrow-connector">â‡¨</div>
            
            <!-- ç‡Ÿæ¥­æˆæœ¬ + ç‡Ÿæ¥­æ¯›åˆ© -->
            <div class="waterfall-bar">
                <div class="bar-stack height-100">
                    <div class="bar-section cost" style="height: 90px;">
                        ç‡Ÿæ¥­<br>æˆæœ¬
                    </div>
                    <div class="bar-section remaining" style="flex: 1;">
                        ç‡Ÿæ¥­<br>æ¯›åˆ©
                    </div>
                </div>
                <div class="bar-label"><span class="deduct-text">æ‰£é™¤</span>ç‡Ÿæ¥­æˆæœ¬</div>
            </div>
            
            <div class="arrow-connector">â‡¨</div>
            
            <!-- ç‡Ÿæ¥­è²»ç”¨ + ç‡Ÿæ¥­åˆ©ç›Š -->
            <div class="waterfall-bar">
                <div class="bar-stack" style="height: 260px;">
                    <div class="bar-section cost" style="height: 90px;">
                        ç‡Ÿæ¥­<br>è²»ç”¨
                    </div>
                    <div class="bar-section remaining" style="flex: 1;">
                        ç‡Ÿæ¥­<br>åˆ©ç›Š
                    </div>
                </div>
                <div class="bar-label"><span class="deduct-text">æ‰£é™¤</span>ç‡Ÿæ¥­è²»ç”¨</div>
            </div>
            
            <div class="arrow-connector">â‡¨</div>
            
            <!-- æ¥­å¤–æ”¯å‡º + ç¨…å‰æ·¨åˆ© -->
            <div class="waterfall-bar">
                <div class="bar-stack" style="height: 170px;">
                    <div class="bar-section cost" style="height: 70px;">
                        æ¥­å¤–<br>æ”¯å‡º
                    </div>
                    <div class="bar-section remaining" style="flex: 1;">
                        ç¨…å‰<br>æ·¨åˆ©
                    </div>
                </div>
                <div class="bar-label"><span class="deduct-text">æ‰£é™¤</span>æ¥­å¤–æç›Š</div>
            </div>
            
            <div class="arrow-connector">â‡¨</div>
            
            <!-- ç¨…è²» + æœ¬æœŸæ·¨åˆ© -->
            <div class="waterfall-bar">
                <div class="bar-stack" style="height: 100px;">
                    <div class="bar-section cost" style="height: 50px;">
                        ç¨…è²»
                    </div>
                    <div class="bar-section remaining" style="flex: 1; background: #4927F5;">
                        æœ¬æœŸ<br>æ·¨åˆ©
                    </div>
                </div>
                <div class="bar-label"><span class="deduct-text">æ‰£é™¤</span>ç¨…è²»</div>
            </div>
        </div>
        
        <div class="info-note">
            ğŸ’¡ æ¯›åˆ©ä¸å¤ æœƒå°è‡´ç„¡æ³•æ”¯ä»˜è²»ç”¨ï¼Œé€£å¸¶è‘—æœ¬æœŸæ·¨åˆ©ä¹Ÿä¸æœƒæé«˜ï¼
        </div>
        
        <div class="formula-box">
            <h3>ğŸ“ é—œéµå…¬å¼</h3>
            <div class="formula-item">
                <strong>æ¯›åˆ©ç‡</strong> = (ç‡Ÿæ¥­æ¯›åˆ© Ã· ç‡Ÿæ¥­æ”¶å…¥) Ã— 100% = [(ç‡Ÿæ¥­æ”¶å…¥ -(æ¸›å») ç‡Ÿæ¥­æˆæœ¬) Ã· ç‡Ÿæ¥­æ”¶å…¥] Ã— 100%
            </div>
            <div class="formula-item">
                <strong><label style="color: #4927F5;">æ·¨åˆ©ç‡ï¼š</label></strong> = (æœ¬æœŸæ·¨åˆ© Ã· ç‡Ÿæ¥­æ”¶å…¥) Ã— 100%
            </div>
            <div class="formula-item">
                ğŸ’¡ <strong><label style="color: #000000;">åˆ©ç‡å·®å€¼</label></strong> = æ¯›åˆ©ç‡ -(æ¸›å») æ·¨åˆ©ç‡(åæ˜ ç‡Ÿæ¥­è²»ç”¨ã€æ¥­å¤–æç›ŠåŠç¨…é‡‘çš„å½±éŸ¿)
            </div>
        </div>
        </div>
    </div>
    
    <!-- ç¯©é¸é¢æ¿ -->
    <div id="filter-panel">
        <div class="filter-row">
            <div style="background-color: rgba(0, 123, 255, 0.15); padding: 10px; border-radius: 8px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                <div class="filter-group" style="background-color: rgba(255, 0, 0, 0.08); padding: 10px; border-radius: 6px;">
                    <label style="color: #ff0000;">æ¯›åˆ©ç‡ï¼š</label>
                    <div class="input-with-tooltip">
                        <input type="number" id="grossMarginMin" placeholder="æœ€å°å€¼" step="0.1" value="0">
                        <span class="input-tooltip">å¯ä»¥è¼¸å…¥è² å€¼ï¼Œå¦‚-100</span>
                    </div>
                    <span>%</span>
                    <span>~</span>
                    <input type="number" id="grossMarginMax" placeholder="æœ€å¤§å€¼" step="0.1" value="100">
                    <span>%</span>
                </div>
                
                <div class="filter-group" style="background-color: rgba(73, 39, 245, 0.08); padding: 10px; border-radius: 6px;">
                    <label style="color: #4927F5;">æ·¨åˆ©ç‡ï¼š</label>
                    <div class="input-with-tooltip">
                        <input type="number" id="netMarginMin" placeholder="æœ€å°å€¼" step="0.1" value="0">
                        <span class="input-tooltip">å¯ä»¥è¼¸å…¥è² å€¼ï¼Œå¦‚-100</span>
                    </div>
                    <span>%</span>
                    <span>~</span>
                    <input type="number" id="netMarginMax" placeholder="æœ€å¤§å€¼" step="0.1" value="100">
                    <span>%</span>
                </div>
                
                <div class="filter-group" style="background-color: rgba(108, 117, 125, 0.1); padding: 10px; border-radius: 6px;">
                    <label>åˆ©ç‡å·®å€¼ï¼š</label>
                    <div class="input-with-tooltip">
                        <input type="number" id="marginDiffMin" placeholder="æœ€å°å€¼" step="0.1" value="0">
                        <span class="input-tooltip">å¯ä»¥è¼¸å…¥è² å€¼ï¼Œå¦‚-100</span>
                    </div>
                    <span>%</span>
                    <span>~</span>
                    <input type="number" id="marginDiffMax" placeholder="æœ€å¤§å€¼" step="0.1" value="100">
                    <span>%</span>
                    <span style="font-size: 11px; color: #666;">(æ¯›-æ·¨)</span>
                </div>
                
                <div class="filter-buttons">
                    <button class="btn btn-primary" onclick="applyFilter()">å¥—ç”¨ç¯©é¸</button>
                    <button class="btn btn-secondary" onclick="resetFilter()">é‡è¨­</button>
                    <button id="toggleEmojiBtn" class="btn btn-secondary" onclick="toggleEmoji()">é—œé–‰åœ–ç¤º</button>
                    <button id="downloadOfflineBtn" class="btn btn-secondary" onclick="downloadOfflinePage()">ä¸‹è¼‰é›¢ç·šç‰ˆ</button>
                </div>
            </div>
            
            <div class="search-group" style="background-color: rgba(0, 171, 94, 0.1); padding: 10px; border-radius: 6px;">
                <label>æœå°‹ï¼š</label>
                <input type="text" id="mopssearchInput" placeholder="å…¬å¸ä»£è™Ÿæˆ–åç¨±">
                <button class="btn btn-primary" onclick="searchCompany()">æœå°‹</button>
            </div>
        </div>
        
        <div id="filter-stats" style="display: none;"></div>
    </div>
    
    <div id="loading">è¼‰å…¥è³‡æ–™ä¸­...</div>
    <div id="charts-container"></div>
    
    <!-- å›åˆ°é ‚ç«¯æŒ‰éˆ• -->
    <button id="backToTop" onclick="scrollToTop()">å›åˆ°é ‚ç«¯</button>

    <script>
        // è¨­å®š Chart.js å…¨åŸŸé è¨­å€¼
        Chart.defaults.backgroundColor = 'white';
        Chart.defaults.borderColor = '#e0e0e0';
        Chart.defaults.color = '#333';

        // å…¨åŸŸè®Šæ•¸ï¼šå„²å­˜æ‰€æœ‰å…¬å¸è³‡æ–™å’Œåœ–è¡¨æ˜ å°„
        let allCompaniesData = [];
        let currentRenderedData = null;
        let companyChartMap = {}; // å…¬å¸ä»£è™Ÿ/åç¨± -> åœ–è¡¨å…ƒç´ çš„æ˜ å°„
        let chartInstances = {}; // å„²å­˜ Chart.js å¯¦ä¾‹ï¼Œç”¨æ–¼æ‡¶åŠ è¼‰
        let observerInstance = null; // Intersection Observer å¯¦ä¾‹

        // emoji é¡¯ç¤ºé–‹é—œï¼ˆé è¨­é¡¯ç¤ºï¼‰
        window.__MOPS_SHOW_EMOJI__ = true;
        
        // æ‹–æ‹½ç›¸é—œè®Šæ•¸
        let draggedElement = null;
        let dragStartX = 0;
        let dragStartY = 0;
        let dragOffsetX = 0;
        let dragOffsetY = 0;

        // è¼‰å…¥ JSON è³‡æ–™ä¸¦å»ºç«‹åœ–è¡¨ï¼ˆæ”¯æ´é›¢ç·šæ‰“åŒ…ï¼šè‹¥ window.__MOPS_OFFLINE_DATA__ å­˜åœ¨å°±ç›´æ¥ä½¿ç”¨ï¼‰
        async function loadAllCompaniesData() {
            const offlineData = window.__MOPS_OFFLINE_DATA__;
            if (Array.isArray(offlineData) && offlineData.length > 0) {
                allCompaniesData = offlineData;
                const loading = document.getElementById('loading');
                loading.style.display = 'none';
                renderCharts(allCompaniesData);
                return;
            }

            //const response = await fetch('mops_margin.json', { cache: 'no-store' });
            const response = await fetch('mops_margin_json.asp', { cache: 'no-store' });
            const data = await response.json();
            allCompaniesData = data;

            const loading = document.getElementById('loading');
            loading.style.display = 'none';

            // åˆå§‹é¡¯ç¤ºæ‰€æœ‰åœ–è¡¨
            renderCharts(allCompaniesData);
        }

        loadAllCompaniesData().catch(error => {
            console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
            const loading = document.getElementById('loading');
            loading.innerHTML = '<div style="color: #dc3545;"><strong>âŒ è¼‰å…¥è³‡æ–™å¤±æ•—</strong><br><br>' +
                               error.message + '<br><br>è«‹æª¢æŸ¥ï¼š<br>' +
                               '1. mops_margin.json æ˜¯å¦æ­£å¸¸åŸ·è¡Œ<br>' +
                               '2. è³‡æ–™åº«é€£ç·šæ˜¯å¦æ­£å¸¸<br>' +
                               '3. é–‹å•Ÿç€è¦½å™¨ Console (F12) æŸ¥çœ‹è©³ç´°éŒ¯èª¤è¨Šæ¯</div>';
        });

        // å»ºç«‹åœ–è¡¨ä½”ä½ç¬¦ï¼ˆæ‡¶åŠ è¼‰å„ªåŒ–ï¼‰
        function createChartPlaceholder(container, company, index) {
            // å»ºç«‹åœ–è¡¨å®¹å™¨
            const wrapper = document.createElement('div');
            wrapper.className = 'chart-wrapper';
            wrapper.dataset.index = index;
            wrapper.dataset.loaded = 'false';
            
            // å»ºç«‹è‡ªå®šç¾©æ¨™é¡Œå€åŸŸï¼ˆåŒ…å«æ–‡å­—å’Œåœ–ç‰‡ï¼‰
            const titleContainer = document.createElement('div');
            titleContainer.style.cssText = 'display: flex; align-items: center; gap: 10px; margin-bottom: 5px; position: relative; z-index: 1; overflow: hidden;';
            
            // æ¨™é¡Œæ–‡å­—ï¼ˆå¯é»æ“Šï¼‰
            const titleText = document.createElement('span');
            titleText.style.cssText = 'font-size: 14px; white-space: nowrap; cursor: pointer;';
            titleText.addEventListener('click', function() {
                window.open('https://gd.myftp.org/lb/lh.asp?stockno=' + company.companyCode, '_blank');
            });
            
            // å…¬å¸ä»£è™Ÿå’Œåç¨±ï¼ˆé»‘è‰²ç²—é«”ï¼‰
            const companyInfo = document.createElement('span');
            companyInfo.textContent = company.companyCode + ' ' + company.companyName + ' ';
            companyInfo.style.cssText = 'font-size: 22px;color: #000; font-weight: bold;';
            titleText.appendChild(companyInfo);
            
            // æ”¶ç›¤åƒ¹ï¼ˆæ ¹æ“š change å€¼æ±ºå®šé¡è‰²ï¼‰
            const priceInfo = document.createElement('span');
            priceInfo.textContent = company.closePrice;
            let priceColor = '#000'; // é è¨­é»‘è‰²
            if (company.change > 0) {
                priceColor = '#ff0000'; // ç´…è‰²
            } else if (company.change < 0) {
                priceColor = '#00AB5E'; // ç¶ è‰²
            }
            priceInfo.style.cssText = 'font-size: 28px; color: ' + priceColor + '; font-weight: bold;';
            titleText.appendChild(priceInfo);
            
            // è®Šå‹•å€¼ï¼ˆæ ¹æ“šæ­£è² æ±ºå®šé¡è‰²ï¼‰
            const changeInfo = document.createElement('span');
            let changeColor = '#000'; // é è¨­é»‘è‰²
            let changeText = company.change;
            if (company.change > 0) {
                changeColor = '#ff0000'; // ç´…è‰²
                changeText = '+' + company.change;
            } else if (company.change < 0) {
                changeColor = '#00AB5E'; // ç¶ è‰²
            }
            changeInfo.textContent = ' (' + changeText + ')';
            changeInfo.style.cssText = 'font-size: 22px; color: ' + changeColor + '; font-weight: bold;';
            titleText.appendChild(changeInfo);
            
            titleContainer.appendChild(titleText);
            
            // å¤–éƒ¨åœ–ç‰‡ï¼ˆæ‡¶åŠ è¼‰ï¼‰
            const img = document.createElement('img');
            img.dataset.src = 'https://mickyang12.github.io/DayChart/120DayChart/' + company.companyCode + '.png';
            img.alt = company.companyCode + ' 120æ—¥ç·šåœ–';
            img.style.cssText = 'max-height: 20px; height: auto; border-radius: 4px;';
            img.onerror = function() {
                this.style.display = 'none';
            };
            titleContainer.appendChild(img);
            
            // crossDays è³‡è¨Šé¡¯ç¤ºï¼ˆå¯é»æ“Šé€£çµï¼‰
            if (company.crossDays !== undefined && company.crossDays !== null) {
                const crossDaysInfo = document.createElement('span');
                crossDaysInfo.textContent = ' W' + company.crossDays + 'å¤©'; 
                const bgColor = company.crossDays > 0 ? 'background-color: yellow; ' : '';
                crossDaysInfo.style.cssText = bgColor + 'font-size: 22px; color: #993333; font-weight: bold; cursor: pointer; text-decoration: underline;';
                crossDaysInfo.addEventListener('click', function(e) {
                    e.stopPropagation();
                    window.open('https://gd.myftp.org/lb/kchart.asp?stockno=' + company.companyCode, '_blank');
                });
                titleText.appendChild(crossDaysInfo);
            }
            
            wrapper.appendChild(titleContainer);
            
            // å»ºç«‹ canvas å®¹å™¨
            const canvasContainer = document.createElement('div');
            canvasContainer.style.cssText = 'position: relative; z-index: 10; margin-top: 10px;';
            
            // å»ºç«‹ canvas å…ƒç´ ï¼ˆä½†ä¸ç«‹å³ç¹ªè£½åœ–è¡¨ï¼‰
            const canvas = document.createElement('canvas');
            canvas.id = 'chart-' + index;
            canvas.className = 'chart-canvas';
            canvasContainer.appendChild(canvas);
            wrapper.appendChild(canvasContainer);
            container.appendChild(wrapper);
            
            return wrapper;
        }
        
        // å…¨åŸŸæ»‘é¼ ç§»å‹•äº‹ä»¶
        document.addEventListener('mousemove', function(e) {
            if (draggedElement) {
                const x = e.clientX - dragOffsetX;
                const y = e.clientY - dragOffsetY;
                
                draggedElement.style.left = x + 'px';
                draggedElement.style.top = y + 'px';
                
                e.preventDefault();
            }
        });
        
        // å…¨åŸŸæ»‘é¼ æ”¾é–‹äº‹ä»¶
        document.addEventListener('mouseup', function(e) {
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
                
                // æª¢æŸ¥æ˜¯å¦çœŸçš„æœ‰ç§»å‹•ï¼ˆç§»å‹•è¶…é5åƒç´ æ‰ç®—æ‹–æ‹½ï¼‰
                const moved = Math.abs(e.clientX - dragStartX) > 5 || Math.abs(e.clientY - dragStartY) > 5;
                
                if (!moved) {
                    // æ²’æœ‰ç§»å‹•ï¼Œæ¢å¾©åŸä½
                    draggedElement.style.position = '';
                    draggedElement.style.left = '';
                    draggedElement.style.top = '';
                    draggedElement.style.width = '';
                    draggedElement.style.zIndex = '';
                }
                
                draggedElement = null;
            }
        });
        
        // é˜²æ­¢æ‹–æ‹½æ™‚é¸å–æ–‡å­—
        document.addEventListener('selectstart', function(e) {
            if (draggedElement) {
                e.preventDefault();
            }
        });

        // å¯¦éš›å»ºç«‹åœ–è¡¨ï¼ˆç•¶å…ƒç´ é€²å…¥è¦–çª—æ™‚èª¿ç”¨ï¼‰
        function loadChart(wrapper, company, index) {
            // é¿å…é‡è¤‡è¼‰å…¥
            if (wrapper.dataset.loaded === 'true') return;
            
            // è¼‰å…¥åœ–ç‰‡ï¼ˆæ‡¶åŠ è¼‰ï¼‰
            const img = wrapper.querySelector('img[data-src]');
            if (img && img.dataset.src) {
                img.src = img.dataset.src;
                img.removeAttribute('data-src');
            }
            
            const canvas = wrapper.querySelector('canvas');
            if (!canvas) return;
            
            // å»ºç«‹åœ–è¡¨
            const ctx = canvas.getContext('2d');
            
            // å¾ company.periods ç”Ÿæˆæ¨™ç±¤ï¼Œæ ¼å¼è½‰æ›ç‚º yy\nQn
            const labels = company.periods.map(period => {
                // period æ ¼å¼ç‚º "2023Q4"
                const year = period.substring(2, 4); // å–å¹´ä»½å¾Œå…©ä½
                const quarter = period.substring(4); // å–å­£åº¦éƒ¨åˆ† (Q4)
                return year + '' + quarter;
            });
            
            // æ‰¾åˆ°å„é …æŒ‡æ¨™çš„æœ€å¤§å€¼ç´¢å¼•
            const maxNetMarginIndex = company.netMargin.indexOf(Math.max(...company.netMargin));
            const maxGrossMarginIndex = company.grossMargin.indexOf(Math.max(...company.grossMargin));
            const maxRevenueIndex = company.revenue.indexOf(Math.max(...company.revenue));
            
            const showEmoji = !!window.__MOPS_SHOW_EMOJI__;

            // pointStyle / emoji marker
            let netMarginPointStyles = company.netMargin.map(() => 'circle');
            let netMarginPointRadius = company.netMargin.map(() => 3);
            let netMarginPointHoverRadius = company.netMargin.map(() => 5);
            let grossMarginPointStyles = company.grossMargin.map(() => 'circle');
            let grossMarginPointRadius = company.grossMargin.map(() => 3);
            let grossMarginPointHoverRadius = company.grossMargin.map(() => 5);

            if (showEmoji) {
                // å‰µå»ºæ˜Ÿæ˜Ÿ â­ emoji åœ–åƒï¼ˆæ·¨åˆ©ç‡ï¼‰
                const starCanvas = document.createElement('canvas');
                starCanvas.width = 24;
                starCanvas.height = 24;
                const starCtx = starCanvas.getContext('2d');
                starCtx.font = '20px Arial';
                starCtx.textAlign = 'center';
                starCtx.textBaseline = 'middle';
                starCtx.fillText('â­', 12, 12);
                const starImage = new Image();
                starImage.src = starCanvas.toDataURL();

                // å‰µå»ºé‡‘ç‰Œ ğŸ¥‡ emoji åœ–åƒï¼ˆæ¯›åˆ©ç‡ï¼‰
                const medalCanvas = document.createElement('canvas');
                medalCanvas.width = 24;
                medalCanvas.height = 24;
                const medalCtx = medalCanvas.getContext('2d');
                medalCtx.font = '20px Arial';
                medalCtx.textAlign = 'center';
                medalCtx.textBaseline = 'middle';
                medalCtx.fillText('ğŸ¥‡', 12, 12);
                const medalImage = new Image();
                medalImage.src = medalCanvas.toDataURL();

                // ç‚ºæ·¨åˆ©ç‡çš„æ¯å€‹é»è¨­å®šæ¨£å¼ï¼ˆæœ€å¤§å€¼ç”¨æ˜Ÿæ˜Ÿ emojiï¼‰
                netMarginPointStyles = company.netMargin.map((_, idx) =>
                    idx === maxNetMarginIndex ? starImage : 'circle'
                );
                netMarginPointRadius = company.netMargin.map((_, idx) =>
                    idx === maxNetMarginIndex ? 12 : 3
                );
                netMarginPointHoverRadius = company.netMargin.map((_, idx) =>
                    idx === maxNetMarginIndex ? 14 : 5
                );

                // ç‚ºæ¯›åˆ©ç‡çš„æ¯å€‹é»è¨­å®šæ¨£å¼ï¼ˆæœ€å¤§å€¼ç”¨é‡‘ç‰Œ emojiï¼‰
                grossMarginPointStyles = company.grossMargin.map((_, idx) =>
                    idx === maxGrossMarginIndex ? medalImage : 'circle'
                );
                grossMarginPointRadius = company.grossMargin.map((_, idx) =>
                    idx === maxGrossMarginIndex ? 12 : 3
                );
                grossMarginPointHoverRadius = company.grossMargin.map((_, idx) =>
                    idx === maxGrossMarginIndex ? 14 : 5
                );
            }
            
            const chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'æ¯›åˆ©ç‡ (%)',
                            data: company.grossMargin,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            pointStyle: grossMarginPointStyles,
                            pointRadius: grossMarginPointRadius,
                            pointHoverRadius: grossMarginPointHoverRadius,
                            pointBackgroundColor: 'rgb(255, 99, 132)',
                            pointBorderColor: 'rgb(255, 99, 132)',
                            yAxisID: 'y'
                        },
                        {
                            label: 'æ·¨åˆ©ç‡ (%)',
                            data: company.netMargin,
                            borderColor: '#4927F5',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            pointStyle: netMarginPointStyles,
                            pointRadius: netMarginPointRadius,
                            pointHoverRadius: netMarginPointHoverRadius,
                            pointBackgroundColor: '#4927F5',
                            pointBorderColor: '#4927F5',
                            yAxisID: 'y'
                        },
                        {
                            label: 'ç‡Ÿæ¥­æ”¶å…¥ (ä»Ÿå…ƒ)',
                            data: company.revenue,
                            type: 'bar',
                            backgroundColor: 'rgba(51, 133, 255, 0.5)',
                            borderColor: '#3385FF',
                            borderWidth: 1,
                            yAxisID: 'y1'
                        }
                    ]
                },
                plugins: [{
                    id: 'fireEmoji',
                    afterDatasetsDraw: function(chart) {
                        if (!window.__MOPS_SHOW_EMOJI__) return;
                        const ctx = chart.ctx;
                        const meta = chart.getDatasetMeta(2); // ç‡Ÿæ¥­æ”¶å…¥æ˜¯ç¬¬3å€‹dataset (index=2)
                        
                        if (meta && meta.data && meta.data[maxRevenueIndex]) {
                            const bar = meta.data[maxRevenueIndex];
                            const x = bar.x;
                            const y = bar.y;
                            
                            ctx.save();
                            ctx.font = '20px Arial';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'bottom';
                            ctx.fillText('ğŸ”¥', x, y - 5);
                            ctx.restore();
                        }
                    }
                }, {
                    id: 'negativeLineSegments',
                    afterDatasetsDraw: function(chart) {
                        const ctx = chart.ctx;
                        const yScale = chart.scales.y;
                        
                        // è™•ç†æ¯›åˆ©ç‡å’Œæ·¨åˆ©ç‡ï¼ˆdataset 0 å’Œ 1ï¼‰
                        [0, 1].forEach(datasetIndex => {
                            const meta = chart.getDatasetMeta(datasetIndex);
                            if (!meta || meta.hidden) return;
                            
                            const dataset = chart.data.datasets[datasetIndex];
                            const data = dataset.data;
                            const greenColor = '#00FF00';
                            
                            ctx.save();
                            ctx.lineWidth = (dataset.borderWidth || 2) + 1; // ç¨å¾®åŠ ç²—ä»¥è¦†è“‹åŸç·š
                            ctx.strokeStyle = greenColor;
                            ctx.lineCap = 'round';
                            ctx.lineJoin = 'round';
                            
                            const zeroY = yScale.getPixelForValue(0);
                            
                            // éæ­·æ‰€æœ‰æ•¸æ“šé»
                            for (let i = 0; i < data.length - 1; i++) {
                                const currentValue = data[i];
                                const nextValue = data[i + 1];
                                
                                const currentPoint = meta.data[i];
                                const nextPoint = meta.data[i + 1];
                                
                                if (!currentPoint || !nextPoint) continue;
                                
                                // ç²å–æ§åˆ¶é»ï¼ˆç”¨æ–¼è²èŒ²æ›²ç·šï¼‰
                                const cp1x = currentPoint.cp2x || currentPoint.x;
                                const cp1y = currentPoint.cp2y || currentPoint.y;
                                const cp2x = nextPoint.cp1x || nextPoint.x;
                                const cp2y = nextPoint.cp1y || nextPoint.y;
                                
                                // æƒ…æ³1: å…©é»éƒ½å°æ–¼0ï¼Œæ•´æ®µç¶ è‰²
                                if (currentValue < 0 && nextValue < 0) {
                                    ctx.beginPath();
                                    ctx.moveTo(currentPoint.x, currentPoint.y);
                                    ctx.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, nextPoint.x, nextPoint.y);
                                    ctx.stroke();
                                }
                                // æƒ…æ³2: ç©¿è¶Š0è»¸ï¼ˆä¸€æ­£ä¸€è² ï¼‰
                                else if ((currentValue < 0 && nextValue >= 0) || (currentValue >= 0 && nextValue < 0)) {
                                    // ä½¿ç”¨äºŒåˆ†æ³•æ‰¾åˆ°èˆ‡0è»¸çš„äº¤é»åƒæ•¸ t
                                    let t = 0.5;
                                    let iterations = 10;
                                    
                                    for (let iter = 0; iter < iterations; iter++) {
                                        // è¨ˆç®—è²èŒ²æ›²ç·šä¸Š t ä½ç½®çš„ y å€¼
                                        const y = Math.pow(1-t, 3) * currentPoint.y +
                                                  3 * Math.pow(1-t, 2) * t * cp1y +
                                                  3 * (1-t) * Math.pow(t, 2) * cp2y +
                                                  Math.pow(t, 3) * nextPoint.y;
                                        
                                        if (Math.abs(y - zeroY) < 0.5) break;
                                        
                                        if (y > zeroY) {
                                            if (currentValue < 0) t += Math.pow(0.5, iter + 2);
                                            else t -= Math.pow(0.5, iter + 2);
                                        } else {
                                            if (currentValue < 0) t -= Math.pow(0.5, iter + 2);
                                            else t += Math.pow(0.5, iter + 2);
                                        }
                                    }
                                    
                                    // è¨ˆç®—äº¤é»åº§æ¨™
                                    const intersectX = Math.pow(1-t, 3) * currentPoint.x +
                                                       3 * Math.pow(1-t, 2) * t * cp1x +
                                                       3 * (1-t) * Math.pow(t, 2) * cp2x +
                                                       Math.pow(t, 3) * nextPoint.x;
                                    
                                    // ç¹ªè£½è² å€¼éƒ¨åˆ†ï¼ˆç¶ è‰²ï¼‰
                                    if (currentValue < 0) {
                                        // è¨ˆç®—åˆ†å‰²å¾Œçš„æ§åˆ¶é»
                                        const splitCp1x = currentPoint.x + t * (cp1x - currentPoint.x);
                                        const splitCp1y = currentPoint.y + t * (cp1y - currentPoint.y);
                                        const splitCp2x = cp1x + t * (cp2x - cp1x);
                                        const splitCp2y = cp1y + t * (cp2y - cp1y);
                                        const splitCp3x = splitCp1x + t * (splitCp2x - splitCp1x);
                                        const splitCp3y = splitCp1y + t * (splitCp2y - splitCp1y);
                                        
                                        ctx.beginPath();
                                        ctx.moveTo(currentPoint.x, currentPoint.y);
                                        ctx.bezierCurveTo(splitCp1x, splitCp1y, splitCp3x, splitCp3y, intersectX, zeroY);
                                        ctx.stroke();
                                    } else {
                                        // è¨ˆç®—åˆ†å‰²å¾Œçš„æ§åˆ¶é»
                                        const splitCp1x = cp1x + t * (cp2x - cp1x);
                                        const splitCp1y = cp1y + t * (cp2y - cp1y);
                                        const splitCp2x = cp2x + t * (nextPoint.x - cp2x);
                                        const splitCp2y = cp2y + t * (nextPoint.y - cp2y);
                                        const splitCp3x = splitCp1x + t * (splitCp2x - splitCp1x);
                                        const splitCp3y = splitCp1y + t * (splitCp2y - splitCp1y);
                                        
                                        ctx.beginPath();
                                        ctx.moveTo(intersectX, zeroY);
                                        ctx.bezierCurveTo(splitCp3x, splitCp3y, splitCp2x, splitCp2y, nextPoint.x, nextPoint.y);
                                        ctx.stroke();
                                    }
                                }
                            }
                            
                            ctx.restore();
                        });
                    }
                }],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: false
                        },
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 10,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    // é¡¯ç¤ºå¯¦éš›æœŸé–“è€Œä¸æ˜¯ Q-8, Q-7 ç­‰
                                    const index = context[0].dataIndex;
                                    return company.periods[index];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            beginAtZero: true,
                            title: {
                                display: false
                            },
                            ticks: {
                                stepSize: 10,
                                callback: function(value) {
                                    return value + '%';
                                },
                                color: function(context) {
                                    // å¦‚æœæ•¸å€¼å°æ–¼ 0ï¼Œä½¿ç”¨ç´…è‰²
                                    return context.tick.value < 0 ? '#ff0000' : '#666';
                                },
                                font: {
                                    size: 10
                                }
                            },
                            grid: {
                                color: function(context) {
                                    if (context.tick.value === 0) {
                                        return '#000000';  // Yè»¸0çš„æ°´å¹³ç·šæ”¹æˆé»‘è‰²
                                    }
                                    return 'rgba(200, 200, 200, 0.3)';
                                },
                                lineWidth: function(context) {
                                    if (context.tick.value === 0) {
                                        return 2;  // Yè»¸0çš„æ°´å¹³ç·šå¯¬åº¦
                                    }
                                    return 1;
                                },
                                borderDash: function(context) {
                                    if (context.tick.value === 0) {
                                        return [];  // Yè»¸0çš„æ°´å¹³ç·šç‚ºå¯¦ç·šï¼ˆä¸ä½¿ç”¨è™›ç·šï¼‰
                                    }
                                    return [5, 5];
                                },
                                drawBorder: false
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            beginAtZero: true,
                            grace: '10%',
                            title: {
                                display: false
                            },
                            ticks: {
                                callback: function(value) {
                                    // å°‡åŸå§‹æ•¸å€¼ä¹˜ä»¥ 1000 å¾—åˆ°çœŸå¯¦é‡‘é¡ï¼ˆä»Ÿå…ƒ -> å…ƒï¼‰
                                    const realValue = value * 1000;
                                    
                                    // åˆ¤æ–·æ•¸æ“šç¯„åœï¼Œå‹•æ…‹é¸æ“‡å–®ä½
                                    if (realValue >= 10000000000000000) {
                                        // >= 1äº¬ï¼Œé¡¯ç¤ºã€Œäº¬ã€ç‚ºå–®ä½
                                        const result = realValue / 10000000000000000;
                                        return (result % 1 === 0 ? result.toFixed(0) : result.toFixed(1)) + 'äº¬';
                                    } else if (realValue >= 1000000000000) {
                                        // >= 1å…†ï¼Œé¡¯ç¤ºã€Œå…†ã€ç‚ºå–®ä½
                                        const result = realValue / 1000000000000;
                                        return (result % 1 === 0 ? result.toFixed(0) : result.toFixed(1)) + 'å…†';
                                    } else if (realValue >= 100000000) {
                                        // >= 1å„„ï¼Œé¡¯ç¤ºã€Œå„„ã€ç‚ºå–®ä½
                                        const result = realValue / 100000000;
                                        return (result % 1 === 0 ? result.toFixed(0) : result.toFixed(1)) + 'å„„';
                                    } else if (realValue >= 10000000) {
                                        // >= 1åƒè¬ï¼Œé¡¯ç¤ºã€Œåƒè¬ã€ç‚ºå–®ä½
                                        const result = realValue / 10000000;
                                        return (result % 1 === 0 ? result.toFixed(0) : result.toFixed(1)) + 'åƒè¬';
                                    } else if (realValue >= 1000000) {
                                        // >= 1ç™¾è¬ï¼Œé¡¯ç¤ºã€Œç™¾è¬ã€ç‚ºå–®ä½
                                        const result = realValue / 1000000;
                                        return (result % 1 === 0 ? result.toFixed(0) : result.toFixed(1)) + 'ç™¾è¬';
                                    }
                                    return realValue;
                                },
                                font: {
                                    size: 10
                                }
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
            
            // å„²å­˜åœ–è¡¨å¯¦ä¾‹
            chartInstances[index] = chartInstance;
            
            // æ¨™è¨˜ç‚ºå·²è¼‰å…¥
            wrapper.dataset.loaded = 'true';
        }

        // åˆå§‹åŒ– Intersection Observerï¼ˆæ‡¶åŠ è¼‰è§€å¯Ÿå™¨ï¼‰
        function initIntersectionObserver(filteredData) {
            // æ¸…é™¤èˆŠçš„ observer
            if (observerInstance) {
                observerInstance.disconnect();
            }
            
            // å‰µå»ºæ–°çš„ observer
            observerInstance = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const wrapper = entry.target;
                        const index = parseInt(wrapper.dataset.index);
                        const company = filteredData[index];
                        
                        if (company && wrapper.dataset.loaded === 'false') {
                            loadChart(wrapper, company, index);
                        }
                    }
                });
            }, {
                root: null,
                rootMargin: '200px', // æå‰ 200px é–‹å§‹è¼‰å…¥
                threshold: 0.01
            });
            
            // è§€å¯Ÿæ‰€æœ‰åœ–è¡¨å®¹å™¨
            document.querySelectorAll('.chart-wrapper').forEach(wrapper => {
                observerInstance.observe(wrapper);
            });
        }

        // æ¸²æŸ“åœ–è¡¨å‡½å¼ï¼ˆæ”¯æ´ç¯©é¸ + æ‡¶åŠ è¼‰ï¼‰
        function renderCharts(filteredData) {
            const container = document.getElementById('charts-container');

            currentRenderedData = filteredData;
            
            // éŠ·æ¯€æ‰€æœ‰ç¾æœ‰çš„åœ–è¡¨å¯¦ä¾‹
            Object.values(chartInstances).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            
            // æ¸…ç©ºå®¹å™¨å’Œæ˜ å°„
            container.innerHTML = '';
            companyChartMap = {};
            chartInstances = {};
            
            let successCount = 0;
            let errorCount = 0;
            
            // ç‚ºæ¯ç­†è³‡æ–™å»ºç«‹åœ–è¡¨ä½”ä½ç¬¦ï¼ˆä¸ç«‹å³å»ºç«‹åœ–è¡¨ï¼‰
            filteredData.forEach((company, index) => {
                try {
                    const chartElement = createChartPlaceholder(container, company, index);
                    
                    // å»ºç«‹å…¬å¸ä»£è™Ÿå’Œåç¨±åˆ°åœ–è¡¨å…ƒç´ çš„æ˜ å°„
                    companyChartMap[company.companyCode] = chartElement;
                    companyChartMap[company.companyName] = chartElement;
                    companyChartMap[company.companyCode + company.companyName] = chartElement;
                    
                    successCount++;
                } catch (error) {
                    errorCount++;
                    console.error('å»ºç«‹åœ–è¡¨ä½”ä½ç¬¦å¤±æ•— (ç´¢å¼• ' + index + '):', error);
                    console.error('å•é¡Œè³‡æ–™:', company);
                }
            });
            
            console.log('åœ–è¡¨ä½”ä½ç¬¦å»ºç«‹å®Œæˆ: æˆåŠŸ ' + successCount + ' ç­†ï¼Œå¤±æ•— ' + errorCount + ' ç­†');
            console.log('åœ–è¡¨å°‡åœ¨æ»¾å‹•åˆ°å¯è¦‹å€åŸŸæ™‚è‡ªå‹•è¼‰å…¥');
            
            if (errorCount > 0) {
                const errorMsg = document.createElement('div');
                errorMsg.style.cssText = 'background: #fff3cd; border: 1px solid #ffc107; padding: 15px; margin: 20px; border-radius: 5px; color: #856404;';
                errorMsg.innerHTML = '<strong>âš ï¸ è­¦å‘Šï¼š</strong> éƒ¨åˆ†è³‡æ–™è¼‰å…¥å¤±æ•— (' + errorCount + ' ç­†)ï¼Œè«‹æª¢æŸ¥ Console æŸ¥çœ‹è©³ç´°è³‡è¨Š';
                const filterPanel = document.getElementById('filter-panel');
                filterPanel.parentNode.insertBefore(errorMsg, filterPanel.nextSibling);
            }
            
            // æ›´æ–°çµ±è¨ˆè³‡è¨Š
            updateFilterStats(filteredData.length, allCompaniesData.length);
            
            // åˆå§‹åŒ–æ‡¶åŠ è¼‰è§€å¯Ÿå™¨
            initIntersectionObserver(filteredData);
        }

        function updateEmojiToggleButton() {
            const btn = document.getElementById('toggleEmojiBtn');
            if (!btn) return;
            btn.textContent = window.__MOPS_SHOW_EMOJI__ ? 'é—œé–‰åœ–ç¤º' : 'é¡¯ç¤ºåœ–ç¤º';
        }

        function toggleEmoji() {
            window.__MOPS_SHOW_EMOJI__ = !window.__MOPS_SHOW_EMOJI__;
            updateEmojiToggleButton();

            // è‹¥å·²è¼‰å…¥è³‡æ–™ï¼Œé‡æ–°æ¸²æŸ“ç›®å‰è¦–åœ–ï¼ˆä¿ç•™ç¯©é¸çµæœï¼‰
            if (Array.isArray(currentRenderedData) && currentRenderedData.length > 0) {
                renderCharts(currentRenderedData);
            }
        }

        // æª¢æŸ¥å…¬å¸æ˜¯å¦ç¬¦åˆç¯©é¸æ¢ä»¶
        function isCompanyMatch(company, grossMin, grossMax, netMin, netMax, diffMin, diffMax) {
            // æª¢æŸ¥æ‰€æœ‰ 8 å­£æ¯›åˆ©ç‡æ˜¯å¦éƒ½åœ¨å€é–“å…§
            if (grossMin !== null || grossMax !== null) {
                for (let i = 0; i < company.grossMargin.length; i++) {
                    const value = company.grossMargin[i];
                    if (grossMin !== null && value < grossMin) return false;
                    if (grossMax !== null && value > grossMax) return false;
                }
            }
            
            // æª¢æŸ¥æ‰€æœ‰ 8 å­£æ·¨åˆ©ç‡æ˜¯å¦éƒ½åœ¨å€é–“å…§
            if (netMin !== null || netMax !== null) {
                for (let i = 0; i < company.netMargin.length; i++) {
                    const value = company.netMargin[i];
                    if (netMin !== null && value < netMin) return false;
                    if (netMax !== null && value > netMax) return false;
                }
            }
            
            // æª¢æŸ¥æ‰€æœ‰ 8 å­£æ¯›åˆ©ç‡èˆ‡æ·¨åˆ©ç‡çš„å·®å€¼æ˜¯å¦éƒ½åœ¨å€é–“å…§
            if (diffMin !== null || diffMax !== null) {
                for (let i = 0; i < company.grossMargin.length; i++) {
                    const diff = company.grossMargin[i] - company.netMargin[i];
                    if (diffMin !== null && diff < diffMin) return false;
                    if (diffMax !== null && diff > diffMax) return false;
                }
            }
            
            return true;
        }

        // å¥—ç”¨ç¯©é¸
        function applyFilter() {
            // å–å¾—ç¯©é¸æ¢ä»¶
            const grossMinInput = document.getElementById('grossMarginMin').value;
            const grossMaxInput = document.getElementById('grossMarginMax').value;
            const netMinInput = document.getElementById('netMarginMin').value;
            const netMaxInput = document.getElementById('netMarginMax').value;
            const diffMinInput = document.getElementById('marginDiffMin').value;
            const diffMaxInput = document.getElementById('marginDiffMax').value;
            
            const grossMin = grossMinInput !== '' ? parseFloat(grossMinInput) : null;
            const grossMax = grossMaxInput !== '' ? parseFloat(grossMaxInput) : null;
            const netMin = netMinInput !== '' ? parseFloat(netMinInput) : null;
            const netMax = netMaxInput !== '' ? parseFloat(netMaxInput) : null;
            const diffMin = diffMinInput !== '' ? parseFloat(diffMinInput) : null;
            const diffMax = diffMaxInput !== '' ? parseFloat(diffMaxInput) : null;
            
            // é©—è­‰è¼¸å…¥
            if (grossMin !== null && grossMax !== null && grossMin > grossMax) {
                alert('æ¯›åˆ©ç‡æœ€å°å€¼ä¸èƒ½å¤§æ–¼æœ€å¤§å€¼');
                return;
            }
            
            if (netMin !== null && netMax !== null && netMin > netMax) {
                alert('æ·¨åˆ©ç‡æœ€å°å€¼ä¸èƒ½å¤§æ–¼æœ€å¤§å€¼');
                return;
            }
            
            if (diffMin !== null && diffMax !== null && diffMin > diffMax) {
                alert('åˆ©ç‡å·®å€¼æœ€å°å€¼ä¸èƒ½å¤§æ–¼æœ€å¤§å€¼');
                return;
            }
            
            // ç¯©é¸è³‡æ–™
            const filteredData = allCompaniesData.filter(company => 
                isCompanyMatch(company, grossMin, grossMax, netMin, netMax, diffMin, diffMax)
            );
            
            // æ¸²æŸ“ç¯©é¸å¾Œçš„åœ–è¡¨
            renderCharts(filteredData);
        }

        // é‡è¨­ç¯©é¸
        function resetFilter() {
            // æ¸…ç©ºè¼¸å…¥æ¬„ä½
            document.getElementById('grossMarginMin').value = '';
            document.getElementById('grossMarginMax').value = '';
            document.getElementById('netMarginMin').value = '';
            document.getElementById('netMarginMax').value = '';
            document.getElementById('marginDiffMin').value = '';
            document.getElementById('marginDiffMax').value = '';
            
            // é¡¯ç¤ºæ‰€æœ‰åœ–è¡¨
            renderCharts(allCompaniesData);
        }

        // æ›´æ–°ç¯©é¸çµ±è¨ˆè³‡è¨Š
        function updateFilterStats(displayCount, totalCount) {
            const statsDiv = document.getElementById('filter-stats');
            
            if (displayCount === totalCount) {
                statsDiv.style.display = 'none';
            } else {
                statsDiv.style.display = 'block';
                statsDiv.innerHTML = 'ğŸ“Š é¡¯ç¤º <strong>' + displayCount + '</strong> ç­†ï¼Œå…± <strong>' + totalCount + '</strong> ç­†è³‡æ–™';
            }
        }

        // æœå°‹å…¬å¸ä¸¦å°‡åœ–è¡¨æ»¾å‹•åˆ°è¢å¹•ä¸­å¤®
        function searchCompany() {
            const searchText = document.getElementById('mopssearchInput').value.trim();
            
            if (!searchText) {
                alert('è«‹è¼¸å…¥æœå°‹é—œéµå­—');
                return;
            }
            
            // ç§»é™¤ä¹‹å‰çš„é«˜äº®
            document.querySelectorAll('.chart-wrapper.highlight').forEach(el => {
                el.classList.remove('highlight');
            });
            
            // æœå°‹åŒ¹é…çš„å…¬å¸
            let found = false;
            for (const [key, element] of Object.entries(companyChartMap)) {
                if (key.includes(searchText)) {
                    // æ‰¾åˆ°åŒ¹é…ï¼Œæ»¾å‹•åˆ°è¢å¹•ä¸­å¤®
                    element.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center' 
                    });
                    
                    // æ·»åŠ é«˜äº®æ•ˆæœ
                    element.classList.add('highlight');
                    
                    // 3ç§’å¾Œç§»é™¤é«˜äº®
                    setTimeout(() => {
                        element.classList.remove('highlight');
                    }, 3000);
                    
                    found = true;
                    break;
                }
            }
            
            if (!found) {
                alert('æ‰¾ä¸åˆ°ç¬¦åˆçš„å…¬å¸ï¼š' + searchText);
            }
        }

        // å›åˆ°é ‚ç«¯åŠŸèƒ½
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
        
        // åˆ‡æ›æµç¨‹åœ–é¡¯ç¤º/éš±è—
        function toggleDiagram() {
            const content = document.getElementById('diagram-content');
            const btn = document.getElementById('diagram-toggle-btn');
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                btn.textContent = 'â–¼ å±•é–‹ æ¯›åˆ©ç‡èˆ‡æ·¨åˆ©ç‡è¨ˆç®—ç€‘å¸ƒåœ–';
            } else {
                content.classList.add('show');
                btn.textContent = 'â–² æ”¶åˆ æ¯›åˆ©ç‡èˆ‡æ·¨åˆ©ç‡è¨ˆç®—ç€‘å¸ƒåœ–';
            }
        }
        
        // ç›£è½æ»¾å‹•äº‹ä»¶ï¼Œæ§åˆ¶æŒ‰éˆ•é¡¯ç¤º/éš±è—
        window.addEventListener('scroll', function() {
            const backToTopBtn = document.getElementById('backToTop');
            if (window.pageYOffset > 300) {
                backToTopBtn.classList.add('show');
            } else {
                backToTopBtn.classList.remove('show');
            }
        });
        
        // æ”¯æ´ Enter éµè§¸ç™¼ç¯©é¸å’Œæœå°‹
        document.addEventListener('DOMContentLoaded', function() {
            updateEmojiToggleButton();

            const filterInputs = document.querySelectorAll('#filter-panel input[type="number"]');
            filterInputs.forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        applyFilter();
                    }
                });
                // ç•¶ focus æ™‚é¸å–å…¨éƒ¨å…§å®¹
                input.addEventListener('focus', function() {
                    this.select();
                });
            });
            
            const mopssearchInput = document.getElementById('mopssearchInput');
            if (mopssearchInput) {
                mopssearchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchCompany();
                    }
                });
                // ç•¶ focus æ™‚é¸å–å…¨éƒ¨å…§å®¹
                mopssearchInput.addEventListener('focus', function() {
                    this.select();
                });
            }
        });

        function escapeHtmlForScriptTag(text) {
            // Avoid breaking out of <script> in downloaded HTML
            return text.replace(/<\//g, '<\\/');
        }

        async function fetchText(url) {
            const res = await fetch(url, { cache: 'no-store' });
            if (!res.ok) throw new Error('fetch failed: ' + url + ' (' + res.status + ')');
            return await res.text();
        }

        function downloadTextFile(filename, content, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        async function downloadOfflinePage() {
            const btn = document.getElementById('downloadOfflineBtn');
            if (!btn) return;

            if (!Array.isArray(allCompaniesData) || allCompaniesData.length === 0) {
                alert('è³‡æ–™å°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹ç¨å¾Œå†è©¦');
                return;
            }

            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'æ‰“åŒ…ä¸­...';

            try {
                // Build a standalone HTML document from current page
                const parser = new DOMParser();
                const doc = parser.parseFromString('<!DOCTYPE html>\n' + document.documentElement.outerHTML, 'text/html');

                // Remove download button from exported file
                const exportedDownloadBtn = doc.getElementById('downloadOfflineBtn');
                if (exportedDownloadBtn && exportedDownloadBtn.parentNode) {
                    exportedDownloadBtn.parentNode.removeChild(exportedDownloadBtn);
                }

                // Offline export: remove 120-day chart <img> entirely (avoid lazy-load/network and empty tags)
                Array.from(doc.querySelectorAll('img')).forEach(img => {
                    const alt = (img.getAttribute('alt') || '');
                    const src = (img.getAttribute('src') || '');
                    const dataSrc = (img.getAttribute('data-src') || '');
                    if (alt.includes('120æ—¥ç·šåœ–') || src.includes('120DayChart') || dataSrc.includes('120DayChart')) {
                        img.remove();
                    }
                });

                // Inline external scripts (Chart.js CDN)
                const externalScripts = Array.from(doc.querySelectorAll('script[src]'));
                for (const s of externalScripts) {
                    const src = s.getAttribute('src');
                    if (!src) continue;
                    btn.textContent = 'å…§åµŒ script...';
                    const code = await fetchText(src);
                    s.removeAttribute('src');
                    s.text = code;
                }

                // Offline export: do NOT embed 120-day PNG images (we remove the <img> entirely)
                const pngMap = {};

                // Embed current JSON + PNG map
                const dataScript = doc.createElement('script');
                dataScript.text =
                    'window.__MOPS_OFFLINE_DATA__ = ' + escapeHtmlForScriptTag(JSON.stringify(allCompaniesData)) + ';\n' +
                    'window.__MOPS_OFFLINE_PNG_MAP__ = ' + escapeHtmlForScriptTag(JSON.stringify(pngMap)) + ';\n' +
                    'window.__MOPS_OFFLINE__ = true;';

                // Inject an override for offline-only DOM tweaks
                const offlineOverrideScript = doc.createElement('script');
                offlineOverrideScript.text =
                    '(function(){\n' +
                    '  try {\n' +
                    '    if (!window.__MOPS_OFFLINE__) return;\n' +
                    '    function __patchOnce(){\n' +
                    '      if (!window.__MOPS_OFFLINE__) return true;\n' +
                    '      if (typeof window.createChartPlaceholder !== "function") return false;\n' +
                    '      var original = window.createChartPlaceholder;\n' +
                    '      window.createChartPlaceholder = function(container, company, index) {\n' +
                    '        var wrapper = original(container, company, index);\n' +
                    '        try {\n' +
                    '          // title: force only companyCode + companyName\n' +
                    '          var titleContainer = wrapper && wrapper.firstElementChild ? wrapper.firstElementChild : null;\n' +
                    '          var titleText = titleContainer && titleContainer.querySelector ? titleContainer.querySelector("span") : null;\n' +
                    '          if (titleText && company && company.companyCode && company.companyName) {\n' +
                    '            titleText.innerHTML = "<span style=\\\"font-size: 22px;color: #000; font-weight: bold;\\\">" +\n' +
                    '              company.companyCode + " " + company.companyName + " \\u003C/span>";\n' +
                    '          }\n' +
                    '          // image: remove 120-day chart <img> entirely\n' +
                    '          var imgs = wrapper && wrapper.querySelectorAll ? wrapper.querySelectorAll("img") : [];\n' +
                    '          for (var i = 0; i < imgs.length; i++) {\n' +
                    '            var alt = imgs[i].getAttribute ? (imgs[i].getAttribute("alt") || "") : "";\n' +
                    '            if (alt.indexOf("120æ—¥ç·šåœ–") !== -1) { imgs[i].remove(); }\n' +
                    '          }\n' +
                    '        } catch (e) {}\n' +
                    '        return wrapper;\n' +
                    '      };\n' +
                    '      return true;\n' +
                    '    }\n' +
                    '    if (!__patchOnce()) {\n' +
                    '      var tries = 0;\n' +
                    '      var timer = setInterval(function(){\n' +
                    '        tries++;\n' +
                    '        if (__patchOnce() || tries > 80) { clearInterval(timer); }\n' +
                    '      }, 50);\n' +
                    '    }\n' +
                    '  } catch (e) {}\n' +
                    '})();';

                // Place data script before the main inline script
                const inlineScripts = Array.from(doc.querySelectorAll('script:not([src])'));
                let inserted = false;
                for (const s of inlineScripts) {
                    const t = (s.textContent || '');
                    if (t.includes("mops_margin.json") || t.includes('loadAllCompaniesData')) {
                        s.parentNode.insertBefore(dataScript, s);
                        s.parentNode.insertBefore(offlineOverrideScript, s);
                        inserted = true;
                        break;
                    }
                }
                if (!inserted) {
                    (doc.body || doc.documentElement).appendChild(dataScript);
                    (doc.body || doc.documentElement).appendChild(offlineOverrideScript);
                }


                // Offline export: never keep lazy-loading attributes
                Array.from(doc.querySelectorAll('img[data-src]')).forEach(img => {
                    img.removeAttribute('data-src');
                });

                // Patch inline scripts so createChartPlaceholder never constructs remote PNG URLs in the offline file
                const allInlineScripts = Array.from(doc.querySelectorAll('script:not([src])'));
                const mainScript = allInlineScripts.find(s => (s.textContent || '').includes('function createChartPlaceholder'));
                if (mainScript) {
                    let t = mainScript.textContent || '';

                    // Remove price/change spans in offline exported file title (no code, no UI)
                    t = t.replace(/\n\s*\/\/\s*æ”¶ç›¤åƒ¹[\s\S]*?titleText\.appendChild\(changeInfo\);\s*/g, '\n');

                    // Remove 120-day chart <img> creation block in offline exported file
                    t = t.replace(/\n\s*\/\/\s*å¤–éƒ¨åœ–ç‰‡ï¼ˆæ‡¶åŠ è¼‰ï¼‰[\s\S]*?titleContainer\.appendChild\(img\);\s*/g, '\n');

                    // Offline: disable image lazy-load in loadChart to avoid any network activity
                    t = t.replace(
                        /\n\s*\/\/\s*è¼‰å…¥åœ–ç‰‡ï¼ˆæ‡¶åŠ è¼‰ï¼‰\s*\n\s*const\s+img\s*=\s*wrapper\.querySelector\('img\[data-src\]'\);\s*\n\s*if\s*\(img\s*&&\s*img\.dataset\.src\)\s*\{\s*\n\s*img\.src\s*=\s*img\.dataset\.src;\s*\n\s*img\.removeAttribute\('data-src'\);\s*\n\s*\}\s*/,
                        "\n            // è¼‰å…¥åœ–ç‰‡ï¼ˆæ‡¶åŠ è¼‰ï¼‰\n            if (!window.__MOPS_OFFLINE__) {\n                const img = wrapper.querySelector('img[data-src]');\n                if (img && img.dataset.src) {\n                    img.src = img.dataset.src;\n                    img.removeAttribute('data-src');\n                }\n            } else {\n                const img = wrapper.querySelector('img[data-src]');\n                if (img) { img.removeAttribute('data-src'); }\n            }\n"
                    );

                    // Replace the hard-coded remote png builder with offline map usage
                    t = t.replace(
                        /img\.dataset\.src\s*=\s*['"][^'"]*120DayChart\/['"]\s*\+\s*company\.companyCode\s*\+\s*['"]\\.png['"];?/g,
                        "const __pngMap = window.__MOPS_OFFLINE_PNG_MAP__;\n            if (window.__MOPS_OFFLINE__ && __pngMap && __pngMap[company.companyCode]) {\n                img.src = __pngMap[company.companyCode];\n                img.removeAttribute('data-src');\n            } else {\n                img.style.display = 'none';\n                img.removeAttribute('data-src');\n            }"
                    );


                    mainScript.textContent = t;
                }

                // Strip packager functions from the exported file to avoid leaking original URLs/implementation
                // Remove everything from the packager marker to the end of that script.
                for (const s of allInlineScripts) {
                    const txt = s.textContent || '';
                    const marker = txt.indexOf('function escapeHtmlForScriptTag');
                    if (marker !== -1) {
                        s.textContent = txt.slice(0, marker);
                    }
                }


                const now = new Date();
                const pad = (n) => String(n).padStart(2, '0');
                const filename = 'mopscharts_offline_' +
                    now.getFullYear() + pad(now.getMonth() + 1) + pad(now.getDate()) + '_' +
                    pad(now.getHours()) + pad(now.getMinutes()) + '.html';

                btn.textContent = 'ç”¢ç”Ÿæª”æ¡ˆ...';
                let html = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;


                downloadTextFile(filename, html, 'text/html;charset=utf-8');

                btn.textContent = originalText;
            } catch (e) {
                console.error(e);
                alert('ä¸‹è¼‰å¤±æ•—ï¼š' + (e && e.message ? e.message : e));
                btn.textContent = originalText;
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
